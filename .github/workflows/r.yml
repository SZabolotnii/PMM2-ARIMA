name: R-CMD-check

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        r-version: ["4.3.1", "4.4.0"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/R
          key: ${{ runner.os }}-r-${{ matrix.r-version }}-${{ hashFiles('DESCRIPTION') }}
          restore-keys: |
            ${{ runner.os }}-r-${{ matrix.r-version }}-

      - name: Install system dependencies
        run: sudo apt-get update -y && sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Install remotes and rcmdcheck
        run: |
          install.packages(c("remotes", "rcmdcheck"))
        shell: Rscript {0}

      - name: Install EstemPMM (custom dependency)
        run: |
          # Try installing from GitHub first
          if (!require("EstemPMM", quietly = TRUE)) {
            tryCatch({
              remotes::install_github("SZabolotnii/EstemPMM", upgrade = "never")
            }, error = function(e) {
              # Fallback: install from local archive
              message("GitHub installation failed, trying local archive...")
              install.packages("EstemPMM2-lib/EstemPMM_0.1.1.tar.gz", repos = NULL, type = "source")
            })
          }
        shell: Rscript {0}

      - name: Install other R package dependencies
        run: |
          remotes::install_deps(dependencies = TRUE)
        shell: Rscript {0}

      - name: R CMD check (без симуляцій)
        run: |
          rcmdcheck::rcmdcheck(
            args = c("--no-manual", "--as-cran"),
            error_on = "error",
            check_dir = "check"
          )
        shell: Rscript {0}

      - name: Save check results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rcmdcheck-results
          path: check
